<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/roboto.css">
		<link rel="stylesheet" href="css/roboto-slab.css">
		<link rel="stylesheet" href="css/fa.css">
		<link rel="stylesheet" href="css/d3-tip-default.css"/>
		<link rel="stylesheet" href="css/typeahead.jquery.css"/>
		<link rel="stylesheet" href="css/datatables.min.css"/>
		<link rel="stylesheet" href="css/header.css">
		<link rel="stylesheet" href="css/iv-subset.css">
		<link rel="stylesheet" href="css/ea-style-guide.css"/>
		<link rel="stylesheet" href="css/usps-data-vis.css"/>
		<link rel="stylesheet" href="css/app.css"/>
		<link href="css/feedbackForm.css" rel="stylesheet">

		<style>
			div.metric-box,
			div.usps-data-vis {
				margin-bottom: 1rem;
			}
			
		</style>
	</head>
	<body>
		<!--- nav -->
		<div id="navigation">
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-auto">
					<h1>Priority Mail Express Daily Failures</h1>
				</div>
				<div class="col">
					<div class="page-controls">
				<button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#piece-table-modal" title="Table view of mail piece details">
				<i class="fa fa-table fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Table view of mail piece details</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:shareLink();" title="Send as Email">
												 <i class="far fa-envelope fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Send as Email</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:setCookie()" title="Save current filter selections">
												 <i class="far fa-save fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Save current filter selections</span>
								  </button>
								  <a class="btn btn-outline-secondary" role="button" target="report-notes" href="notes/IV_PriorityMailExpressDiagnostics_ReportNotes.pdf" title="Report Notes">
												 <i class="far fa-file-alt fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Report Notes</span>
								  </a>                                                
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:controller.resetAll();" title="Reset all filters">
												 <i class="fa fa-sync fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Reset all filters</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" title="Send Feedback" data-toggle="modal" data-target="#feedbackForm">
										<i class="fa fa-edit fa-lg" aria-hidden="true"></i>
										<span class="sr-only">Send Feedback</span>
						 </button>
					</div>
	 </div>

<!-- Form Modal-->
<div class="modal fade" id="feedbackForm" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
	<div class="modal-dialog" role="document">
	  <div class="modal-content">
		<div class="modal-header bg-light">
		  <h5 class="modal-title-custom" id="">Send us your feedback!</h5>
		  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		  </button>
		</div>
		<div class="modal-body">
			<label for="validationMessage">How can we help you <span style="color: red;">*</span></label>
		  <form class="needs-validation" novalidate>
			  
		  <div class="container">
			  
			<div class="row" align="center">
				

				
				
					<div class="custom-control custom-radio mr-4">
							<input type="radio" class="custom-control-input" id="customControlValidation1" name="radio" required>
							<label class="custom-control-label" for="customControlValidation1">Suggestion</label>
						  </div>
						  <div class="custom-control custom-radio mr-4">
								<input type="radio" class="custom-control-input" id="customControlValidation2" name="radio" required>
								<label class="custom-control-label" for="customControlValidation2">Bug Report</label>
							  </div>
						  <div class="custom-control custom-radio">
							<input type="radio" class="custom-control-input" id="customControlValidation3" name="radio" required>
							<label class="custom-control-label" for="customControlValidation3">Have a Question</label>
							<div class="invalid-feedback">Please select one.</div>
						  </div>
						

					<!--
				
				<div class="btn-group btn-group-toggle" data-toggle="buttons">
					<label class="btn btn-outline-primary" for="Validationoption1"> 
					  <input type="radio" name="suggestion" id="Validationoption1" required>Suggestion
					</label>
					<label class="btn btn-outline-primary" for="Validationoption2">
					  <input type="radio" name="bugreport" id="Validationoption2" required>Bug Report
					</label>
					<label class="btn btn-outline-primary" for="Validationoption3">
					  <input type="radio" name="question" id="Validationoption3" required>Have a Question
					</label>
				  </div> 
				  <div class="invalid-feedback">
					Please select one.
				  </div>
				-->
			</div>
		  </div>
	
				
		  <div id="reportName">Report Title: <span>Priority Mail Express Daily Failures</span></div>

		  
			<div class="form-group">
				<label for="validationMessage">Message <span style="color: red;">*</span></label>
				<textarea class="form-control" rows="3" id="validationMessage" required placeholder="Type your message here ..."></textarea>
				<div class="invalid-feedback">
				  Please type your message.
				</div>
			  </div>
	
			<div class="mt-2">
			  <span style="color: red;">*</span><span class="text-muted"> These fields are required.</span>
		<button type="submit" class="btn btn-primary btn-modal">Submit</button></div>
		  </form>
		  
		  <script>
		  // Example starter JavaScript for disabling form submissions if there are invalid fields
		  (function() {
			'use strict';
			window.addEventListener('load', function() {
			  // Fetch all the forms we want to apply custom Bootstrap validation styles to
			  var forms = document.getElementsByClassName('needs-validation');
			  // Loop over them and prevent submission
			  var validation = Array.prototype.filter.call(forms, function(form) {
				form.addEventListener('submit', function(event) {
				  if (form.checkValidity() === false) {
					event.preventDefault();
					event.stopPropagation();
				  }
				  form.classList.add('was-validated');
				}, false);
			  });
			}, false);
		  })();
		  </script>	
		
		</div>
	  </div>
	</div>
  </div>



				<div class="metric-box col-12">
				  <strong>Metric to Display</strong>
				  <form action="">
					&nbsp;&nbsp;
					<input type="radio" id="failed-mode" name="chart-mode" value="failedCount" checked="checked"/>
					
					<label for="display-mode">Failed Piece Count </label>&nbsp&nbsp
					<input type="radio" id="atrisk-mode" name="chart-mode" value="atRisk" />
					<label for="select-mode">$ At Risk </label>&nbsp&nbsp
					<input type="radio" id="estatrisk-mode" name="chart-mode" value="estAtRisk" />
					<label for="select-mode">Estimated $ At Risk </label>
				  </form>
				</div>
			</div>
	
			<div class="row">
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="scheduled-delivery-date" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Failed Volume by Scheduled Delivery Date",
						"attributeName":"Scheduled Delivery Date",
						"attribute":"ScheduledDeliveryDate",
						"dataType":"date",
						"chartType":"barChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="Origin-Area-Name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Origin Area",
						"attribute":"OriginAreaName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="origin-district-name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Origin District",
						"attribute":"OriginDistrictName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
					
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="origin-mpoo-name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Origin MPOO",
						"attribute":"OriginMPOOName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="destination-area-name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Destination Area",
						"attribute":"DestinationAreaName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="destination-district-name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Destination District",
						"attribute":"DestinationDistrictName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="destination-mpoo-name" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Destination MPOO",
						"attribute":"DestinationMPOOName",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="origin-zip-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Acceptance ZIP Code",
						"attribute":"OriginZipCode",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="origin-enroute-zip-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Origin Enroute ZIP Code",
						"attribute":"OriginEnrouteZipcode",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="destination-enroute-zip-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Destination Enroute ZIP Code",
						"attribute":"DestinationEnrouteZipcode",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="first-aau-zip-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"AAU ZIP Code",
						"attribute":"FirstAAUZipCode",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="first-stop-zip-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"1st Stop ZIP Code",
						"attribute":"FirstStopZipCode",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="svc-std-day-time-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Service Standard",
						"attribute":"ServiceStandard",
						"descriptorAccessor":"descriptorServiceStandard",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="scheduled-delivery-ddthr" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Scheduled Delivery Time",
						"attribute":"ScheduledDeliveryDDTHr",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="Failure-Type" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Failure Type",
						"attribute":"FailureType",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="po-box-ind" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"PO Box Indicator",
						"attribute":"POBoxInd",
						"descriptorAccessor":"descriptorYesNo",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="mail-type-designation" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Mail Type Designation",
						"attribute":"MailTypeDesignation",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="npa-designation" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"",
						"attribute":"NPADesignation",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="sales-source-code" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Sales Source Code",
						"attribute":"SalesSourceCode",
						"descriptorAccessor":"descriptorSalesSource",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>
				
				<div class="col-sm-6 col-md-4 col-lg-3">
					<div id="root-cause" class="usps-data-vis" data-usps-data-vis='{
						"chartName":"Missent",
						"attribute":"RootCause",
						"descriptorAccessor":"descriptorMissent",
						"dataType":"string",
						"chartType":"rowChart"}'>
					</div>
				</div>

			</div> <!-- row -->
		</div> <!-- container-fluid -->
		
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/popper.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/typeahead.jquery.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/crossfilter.js"></script>
		<script src="js/d3-tip.js"></script>
		<script src="js/promise-polyfill.js"></script>
		<script src="js/fetch.umd.js"></script>
		<script src="js/datatables.min.js"></script>
		<!-- hack fix for Excel export in IE. Overrides functionality in datatables script above -->
		<script src="js/buttons.html5.js"></script>
		<script src="js/crossfilter-controller.js"></script>
		<script src="js/chart-registry.js"></script>
		<script src="js/chart-control.js"></script>
		<script src="js/usps-charts.js"></script>
		<script src="js/usps-data-vis.js"></script>
		<script src="js/modal-data-table.js"></script>

		<script>
			"use strict";
			
			// Load navigation header
			$('#navigation').load('html/navigation.html');
			
			var metricName = "Total";
			
			var chartOptions = {
				// default options
				keyAccessor: function(d) { 
					return d.key ? d.key : null; 
				},
				descriptorAccessor: function(d) {
					var desc = this.keyAccessor() && this.keyAccessor()(d) || null;
					if (desc == null || desc == '' || desc == '?') {
						desc = 'N/A';
					}
					return desc;
				},
				metricAccessor: function(d) { 
					return d.value[metricName] ? d.value[metricName] : null; 
				},
				metric2Accessor: function(d) {
					return null;
				},
				colors: null,
				labelAccessor: function(d) {
					var k = (this.descriptorAccessor() && this.descriptorAccessor()(d)) ||
						(this.keyAccessor() && this.keyAccessor()(d)) || null;
					var r = this.metric2Accessor() && this.metric2Accessor()(d) || null;
					var l = k ? k instanceof Date ? d3.utcFormat('%b %d, %Y')(k) : k : '';
					l += k && r ? ' — ' : '';
					l += r ? d3.format('0.1%')(r) : '';
					return l;
				},
				formatTip: function(d) {
					var k = (this.descriptorAccessor() && this.descriptorAccessor()(d)) ||
						(this.keyAccessor() && this.keyAccessor()(d)) || null;
					var q = this.metricAccessor() && this.metricAccessor()(d) || null;
					var n = this.options("attributeName") || this.options("chartName") || "Item";
					var t = '<table>'
							+ '<tr><td><span style="font-weight:400;">' + n + ':</span></td><td style="width:2em"></td>'
							+ '<td><span style="font-weight:700;float:right">'+(k && k instanceof Date ? d3.utcFormat('%b %d, %Y')(k) : k)+'</span></td></tr>';

					var metricLabel = 'Failed Piece Count';
					var metricFormat = d3.format(',d');
					if (metricName == 'PostageAmt') {
						metricLabel = '$ At Risk';
						metricFormat = d3.format('$,d');
					} else if (metricName == 'EstPostageAmt') {
						metricLabel = 'Estimated $ At Risk';
						metricFormat = d3.format('$,d');
					}
						
					if (q) {
						t +=  '<tr><td><span style="font-weight:400">'+metricLabel+':</span></td><td style="width:2em"></td>'
							+ '<td><span style="font-weight:700;float:right">'+metricFormat(q)+'</span></td></tr>';
					}
					t += '</table>';
					
					return t;
				},
				
				// custom options
				descriptorYesNo: function(d) {
					return ({
						'Y': 'Yes',
						'N': 'No'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorSalesSource: function(d) {
					return ({
						'R': 'Retail',
						'P': 'PC Postage',
						'M': 'Commercial',
						'O': 'Unknown'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorServiceStandard: function(d) {
					return ({
						'0D': '1 Day',
						'ND': '1 Day',
						'2D': '2 Day'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorMissent: function(d) {
					return ({
						'Not Defined': 'No',
						'Missent': 'Yes'
					})[this.keyAccessor()(d)] || 'N/A';
				}
			}; //chartOptions

			uspsDataVis.build(chartOptions);
			
			var controller = crossfilterController().reduce(
				function(p,v) {
					p.Total += +v.Total;
					p.WithPostageInd += +v.WithPostageInd;
					p.PostageAmt += +v.PostageAmt;
					p.EstPostageAmt = p.PostageAmt * p.Total / (p.WithPostageInd || 1);
					return p;
				},
				function(p,v) {
					p.Total -= +v.Total;
					p.WithPostageInd -= +v.WithPostageInd;
					p.PostageAmt -= +v.PostageAmt;
					p.EstPostageAmt = p.PostageAmt * p.Total / (p.WithPostageInd || 1);
					return p;
				},
				function() {
					return {
						Total: 0,
						WithPostageInd: 0,
						PostageAmt: 0,
						EstPostageAmt: 0
					}
				}
			);
			
			controller.dataFilter(function(d) {
				return d.value[metricName] > 0;
			});

			chartRegistry.getChartRecords().forEach(function(d){
				controller.addChart(d.chart, d.ctrl, d.opts.attribute);
			});
			
			// initialize chart data table/modal dialog
			var chartDataTable = modalDataTable();
			chartDataTable.init('chart-table-modal',
			[
				'Item',
				'Failed Piece Count',
				'$ At Risk',
				'Estimated $ At Risk'
			],function(chart,d){
				return [
					chart.descriptorAccessor()(d),
					d3.format(',d')(d.value.Total),
					d3.format('$,d')(d.value.PostageAmt),
					d3.format('$,d')(d.value.EstPostageAmt)
				];
			},function(d){
				return d.value.Total !== 0;
			},
			true);
			
			// Wire up events to controllers, etc.
			
			$('input[type=radio][name=chart-mode]').change(function() {
				metricName = (this.value === 'atRisk')
							? 'PostageAmt'
							: (this.value === 'estAtRisk')
								? 'EstPostageAmt'
								: 'Total';

				controller.redrawAll();
			});
			
			// Enable popovers (in navigation header)
			$(function () {
			  $('[data-toggle="popover"]').popover({
				container: 'body'
			  })
			});
			
			$('.popover-dismiss').popover({
			  trigger: 'focus'
			});
			
			// Load the data and display the charts
			d3.dsv("|", 'PMEFailedPieces.csv', function(d) {
					d.ScheduledDeliveryDate = d3.utcParse('%Y-%m-%d')(d.ScheduledDeliveryDate);
					d.Total = +d.Total;
					d.WithPostageInd = +d.WithPostageInd;
					d.PostageAmt = +d.PostageAmt;
					return d;
				})
				.then(function(data) {
					controller.loadData(data);
					controller.drawAll();
					// Turn off controls for some charts
					chartRegistry.getChartById('scheduled-delivery-date').turnOffControl('sort');
					chartRegistry.getChartById('scheduled-delivery-date').turnOffControl('find');
				});
			
			var resizeCharts = (function(){
				var timeout;
				
				var r = function() {
					chartRegistry.getCharts().forEach(function(chart) {
						var w = chart.width();
						chart.naturalWidth();
						if (w !== chart.width()) {
							chart.draw(); 
						}
					});
				};
				
				return function() {
					clearTimeout(timeout);
					timeout = setTimeout(r, 250);
				}
			})();
			
			window.onresize = resizeCharts;
			
			window.addEventListener('orientationchange', resizeCharts, false);
		
		</script>
		
	</body>
</html>