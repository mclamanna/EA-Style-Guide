<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/roboto.css">
		<link rel="stylesheet" href="css/roboto-slab.css">
		<link rel="stylesheet" href="css/fa.css">
		<link rel="stylesheet" href="css/d3-tip-default.css"/>
		<link rel="stylesheet" href="css/typeahead.jquery.css"/>
		<link rel="stylesheet" href="css/datatables.min.css"/>
		<link rel="stylesheet" href="css/header.css">
		<link rel="stylesheet" href="css/iv-subset.css">
		<link rel="stylesheet" href="css/ea-style-guide.css"/>
		<link rel="stylesheet" href="css/usps-data-vis.css"/>
		<link rel="stylesheet" href="css/app.css"/>
		<link href="css/feedbackForm.css" rel="stylesheet">
		
<!--<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.3.26/jquery.form-validator.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.14.0/jquery.validate.js"></script> -->
		<style>
			div.metric-box,
			div.usps-data-vis {
				margin-bottom: 1rem;
			}
			
		</style>
	</head>
	<body>
		<!--- nav -->
		<div id="navigation">
		</div>
		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-auto">
					<h1>Priority Mail Express Daily Failures</h1>
				</div>
				<div class="col">
					<div class="page-controls">
				<button type="button" class="btn btn-outline-secondary" data-toggle="modal" data-target="#piece-table-modal" title="Table view of mail piece details">
				<i class="fa fa-table fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Table view of mail piece details</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:shareLink();" title="Send as Email">
												 <i class="far fa-envelope fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Send as Email</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:setCookie()" title="Save current filter selections">
												 <i class="far fa-save fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Save current filter selections</span>
								  </button>
								  <a class="btn btn-outline-secondary" role="button" target="report-notes" href="notes/IV_PriorityMailExpressDiagnostics_ReportNotes.pdf" title="Report Notes">
												 <i class="far fa-file-alt fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Report Notes</span>
								  </a>                                                
								  <button type="button" class="btn btn-outline-secondary" onclick="javascript:controller.resetAll();" title="Reset all filters">
												 <i class="fa fa-sync fa-lg" aria-hidden="true"></i>
												 <span class="sr-only">Reset all filters</span>
								  </button>
								  <button type="button" class="btn btn-outline-secondary" title="Send Feedback" data-toggle="modal" data-target="#feedbackForm">
										<i class="fa fa-edit fa-lg" aria-hidden="true"></i>
										<span class="sr-only">Send Feedback</span>
						 </button>
					</div>
	 </div>

<!-- Form Modal-->
<div class="modal fade" id="feedbackForm" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
	<div class="modal-dialog" role="document">
	  <div class="modal-content">
		<div class="modal-header bg-light">
		  <h5 class="modal-title-custom" id="">Send us your feedback!</h5>
		  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		  </button>
		</div>
		<div class="modal-body">
			<form id="sales-form" name="sales-form" method="post" action="" class="form-inline">
    <fieldset>
        <legend>Sale Item Form</legend>
        <div class="control-group">
            <label for="sale-name">Item name</label>
            <input type="text" id="sale-name" required="required" />
        </div>
        <div class="control-group">
            <label for="SaleType">Is your item new or used?</label>
            <div class="btn-group" id="divSaleType" data-toggle="buttons-radio" name="divSaleType">
                <button name="New" class="btn btn-info SaleTypeToggle" id="ContentPlaceHolder1_ContentPlaceHolder1_btnNew" type="button" value="new">New</button>
                <button name="Used" class="btn btn-info SaleTypeToggle" id="ContentPlaceHolder1_ContentPlaceHolder1_btnUsed" type="button" value="used">Used</button>
            </div>
            <input  type="hidden" name="SaleType" id="SaleType" required="required" />
        </div>
        <hr />
        <button class="btn btn-primary">Submit</button>
    </fieldset>
</form>
			
		  
		  
			<script>
			  $(document).ready(function() {
    //Bind the click event to the parent div containing both buttons. Tell it to fire on any element containing the class btn.
    $('#divSaleType').on('click', '.btn', function () {
        $('#SaleType').val($(this).val());
    });

    //Validate the form
    $('#sales-form').validate({
        ignore: [],
        //For demo, show submitted values:
        submitHandler: function () {
            alert('Submitted form. Name: ' + $('#sale-name').val() + '; Sale type: ' + $('#SaleType').val());
        }
    });
    
    
});
			</script>	
		
		</div>
	  </div>
	</div>
</div>
	





				<div class="metric-box col-12">
				  <strong>Metric to Display</strong>
				  <form action="">
					&nbsp;&nbsp;
					<input type="radio" id="failed-mode" name="chart-mode" value="failedCount" checked="checked"/>
					
					<label for="display-mode">Failed Piece Count </label>&nbsp&nbsp
					<input type="radio" id="atrisk-mode" name="chart-mode" value="atRisk" />
					<label for="select-mode">$ At Risk </label>&nbsp&nbsp
					<input type="radio" id="estatrisk-mode" name="chart-mode" value="estAtRisk" />
					<label for="select-mode">Estimated $ At Risk </label>
				  </form>
				</div>
			</div>
	
			
		</div> <!-- container-fluid -->
		
		<script src="js/jquery-3.3.1.min.js"></script>
		<script src="js/popper.js"></script>
		<script src="js/bootstrap.min.js"></script>
		
		<script src="js/jquery.validate.js"></script>
		
		<script src="js/typeahead.jquery.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/crossfilter.js"></script>
		<script src="js/d3-tip.js"></script>
		<script src="js/promise-polyfill.js"></script>
		<script src="js/fetch.umd.js"></script>
		<script src="js/datatables.min.js"></script>
		<!-- hack fix for Excel export in IE. Overrides functionality in datatables script above -->
		<script src="js/buttons.html5.js"></script>
		<script src="js/crossfilter-controller.js"></script>
		<script src="js/chart-registry.js"></script>
		<script src="js/chart-control.js"></script>
		<script src="js/usps-charts.js"></script>
		<script src="js/usps-data-vis.js"></script>
		<script src="js/modal-data-table.js"></script>

		<script>
			"use strict";
			
			// Load navigation header
			$('#navigation').load('html/navigation.html');
			
			var metricName = "Total";
			
			var chartOptions = {
				// default options
				keyAccessor: function(d) { 
					return d.key ? d.key : null; 
				},
				descriptorAccessor: function(d) {
					var desc = this.keyAccessor() && this.keyAccessor()(d) || null;
					if (desc == null || desc == '' || desc == '?') {
						desc = 'N/A';
					}
					return desc;
				},
				metricAccessor: function(d) { 
					return d.value[metricName] ? d.value[metricName] : null; 
				},
				metric2Accessor: function(d) {
					return null;
				},
				colors: null,
				labelAccessor: function(d) {
					var k = (this.descriptorAccessor() && this.descriptorAccessor()(d)) ||
						(this.keyAccessor() && this.keyAccessor()(d)) || null;
					var r = this.metric2Accessor() && this.metric2Accessor()(d) || null;
					var l = k ? k instanceof Date ? d3.utcFormat('%b %d, %Y')(k) : k : '';
					l += k && r ? ' â€” ' : '';
					l += r ? d3.format('0.1%')(r) : '';
					return l;
				},
				formatTip: function(d) {
					var k = (this.descriptorAccessor() && this.descriptorAccessor()(d)) ||
						(this.keyAccessor() && this.keyAccessor()(d)) || null;
					var q = this.metricAccessor() && this.metricAccessor()(d) || null;
					var n = this.options("attributeName") || this.options("chartName") || "Item";
					var t = '<table>'
							+ '<tr><td><span style="font-weight:400;">' + n + ':</span></td><td style="width:2em"></td>'
							+ '<td><span style="font-weight:700;float:right">'+(k && k instanceof Date ? d3.utcFormat('%b %d, %Y')(k) : k)+'</span></td></tr>';

					var metricLabel = 'Failed Piece Count';
					var metricFormat = d3.format(',d');
					if (metricName == 'PostageAmt') {
						metricLabel = '$ At Risk';
						metricFormat = d3.format('$,d');
					} else if (metricName == 'EstPostageAmt') {
						metricLabel = 'Estimated $ At Risk';
						metricFormat = d3.format('$,d');
					}
						
					if (q) {
						t +=  '<tr><td><span style="font-weight:400">'+metricLabel+':</span></td><td style="width:2em"></td>'
							+ '<td><span style="font-weight:700;float:right">'+metricFormat(q)+'</span></td></tr>';
					}
					t += '</table>';
					
					return t;
				},
				
				// custom options
				descriptorYesNo: function(d) {
					return ({
						'Y': 'Yes',
						'N': 'No'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorSalesSource: function(d) {
					return ({
						'R': 'Retail',
						'P': 'PC Postage',
						'M': 'Commercial',
						'O': 'Unknown'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorServiceStandard: function(d) {
					return ({
						'0D': '1 Day',
						'ND': '1 Day',
						'2D': '2 Day'
					})[this.keyAccessor()(d)] || 'N/A';
				},
				descriptorMissent: function(d) {
					return ({
						'Not Defined': 'No',
						'Missent': 'Yes'
					})[this.keyAccessor()(d)] || 'N/A';
				}
			}; //chartOptions

			uspsDataVis.build(chartOptions);
			
			var controller = crossfilterController().reduce(
				function(p,v) {
					p.Total += +v.Total;
					p.WithPostageInd += +v.WithPostageInd;
					p.PostageAmt += +v.PostageAmt;
					p.EstPostageAmt = p.PostageAmt * p.Total / (p.WithPostageInd || 1);
					return p;
				},
				function(p,v) {
					p.Total -= +v.Total;
					p.WithPostageInd -= +v.WithPostageInd;
					p.PostageAmt -= +v.PostageAmt;
					p.EstPostageAmt = p.PostageAmt * p.Total / (p.WithPostageInd || 1);
					return p;
				},
				function() {
					return {
						Total: 0,
						WithPostageInd: 0,
						PostageAmt: 0,
						EstPostageAmt: 0
					}
				}
			);
			
			controller.dataFilter(function(d) {
				return d.value[metricName] > 0;
			});

			chartRegistry.getChartRecords().forEach(function(d){
				controller.addChart(d.chart, d.ctrl, d.opts.attribute);
			});
			
			// initialize chart data table/modal dialog
			var chartDataTable = modalDataTable();
			chartDataTable.init('chart-table-modal',
			[
				'Item',
				'Failed Piece Count',
				'$ At Risk',
				'Estimated $ At Risk'
			],function(chart,d){
				return [
					chart.descriptorAccessor()(d),
					d3.format(',d')(d.value.Total),
					d3.format('$,d')(d.value.PostageAmt),
					d3.format('$,d')(d.value.EstPostageAmt)
				];
			},function(d){
				return d.value.Total !== 0;
			},
			true);
			
			// Wire up events to controllers, etc.
			
			$('input[type=radio][name=chart-mode]').change(function() {
				metricName = (this.value === 'atRisk')
							? 'PostageAmt'
							: (this.value === 'estAtRisk')
								? 'EstPostageAmt'
								: 'Total';

				controller.redrawAll();
			});
			
			// Enable popovers (in navigation header)
			$(function () {
			  $('[data-toggle="popover"]').popover({
				container: 'body'
			  })
			});
			
			$('.popover-dismiss').popover({
			  trigger: 'focus'
			});
			
			// Load the data and display the charts
			d3.dsv("|", 'PMEFailedPieces.csv', function(d) {
					d.ScheduledDeliveryDate = d3.utcParse('%Y-%m-%d')(d.ScheduledDeliveryDate);
					d.Total = +d.Total;
					d.WithPostageInd = +d.WithPostageInd;
					d.PostageAmt = +d.PostageAmt;
					return d;
				})
				.then(function(data) {
					controller.loadData(data);
					controller.drawAll();
					// Turn off controls for some charts
					chartRegistry.getChartById('scheduled-delivery-date').turnOffControl('sort');
					chartRegistry.getChartById('scheduled-delivery-date').turnOffControl('find');
				});
			
			var resizeCharts = (function(){
				var timeout;
				
				var r = function() {
					chartRegistry.getCharts().forEach(function(chart) {
						var w = chart.width();
						chart.naturalWidth();
						if (w !== chart.width()) {
							chart.draw(); 
						}
					});
				};
				
				return function() {
					clearTimeout(timeout);
					timeout = setTimeout(r, 250);
				}
			})();
			
			window.onresize = resizeCharts;
			
			window.addEventListener('orientationchange', resizeCharts, false);
		
		</script>
		
	</body>
</html>